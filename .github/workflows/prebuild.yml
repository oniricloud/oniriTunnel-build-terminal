name: Build
on:
  workflow_dispatch:
jobs:
  prebuild:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            arch: x64
          - os: ubuntu-22.04-arm
            platform: linux
            arch: arm64
          - os: macos-14
            platform: darwin
            arch: x64
          - os: macos-14
            platform: darwin
            arch: arm64
          - os: windows-2022
            platform: win32
            arch: x64
          - os: windows-2022
            platform: win32
            arch: arm64
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.tags }}
    steps:
      - uses: actions/checkout@v4
      - name: Support longpaths
        if: ${{ matrix.platform == 'win32' }}
        run: git config --global core.longpaths true
      - uses: actions/cache@v4
        with:
          path: build/_drive
          key: corestore-${{ matrix.platform }}-${{ matrix.arch }}-${{ github.sha }}
          restore-keys: |
            corestore-${{ matrix.platform }}-${{ matrix.arch }}-
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates build-essential git libgtk-4-dev pkg-config fuse file
          # sudo apt-get install -y clang pkg-config libgtk-4-dev clang-tools fuse file
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 20
          npm install --install-links --legacy-peer-deps
        if: ${{ matrix.platform == 'linux' }}
      - run: sudo apt install libatomic1
        if: ${{ matrix.platform == 'linux' }}
      - run: choco upgrade llvm
        if: ${{ matrix.platform == 'win32' }}
      - run: choco install nasm
        if: ${{ matrix.platform == 'win32' }}
      - name: Setup MSBuild and SignTool
        uses: microsoft/setup-msbuild@v1.0.2
        if: ${{ matrix.platform == 'win32' }}
      - name: Install Windows SDK
        run: |
          choco install windows-sdk-10.1 -y
          # Try to find and add SignTool to PATH
          $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits" -Recurse -Name "signtool.exe" | Select-Object -First 1
          if ($signtoolPath) {
            $signtoolDir = Split-Path (Join-Path "C:\Program Files (x86)\Windows Kits" $signtoolPath) -Parent
            echo $signtoolDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Added SignTool directory to PATH: $signtoolDir"
          } else {
            Write-Host "SignTool not found"
          }
        shell: powershell
        if: ${{ matrix.platform == 'win32' }}
      - name: Create temporary signing certificate
        run: |
          # Create a temporary self-signed certificate for code signing
          $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=TempBuildCert" -CertStoreLocation Cert:\CurrentUser\My
          Write-Host "Created temporary certificate with thumbprint: $($cert.Thumbprint)"
          # Export the certificate to make it available for signing
          Export-Certificate -Cert $cert -FilePath "TempBuildCert.cer"
        shell: powershell
        if: ${{ matrix.platform == 'win32' }}
      - run: npm install -g pear
      - run: npm install -g bare-make
      - run: npm install -g bare-build
      - run: npm run install:all
      - name: "Show bare-make version"
        run: bare-make --version
      - name: "Remove build if exists (Linux)"
        if: ${{ matrix.platform == 'linux' }}
        run: rm -rf build
      - name: "Remove build if exists (Windows)"
        if: ${{ matrix.platform == 'win32' }}
        run: |
          if (Test-Path "build") {
            Remove-Item -Path "build" -Recurse -Force
          }
        shell: powershell
      - name: "Build  "
        run: bare-build --standalone --host ${{ matrix.platform }}-${{ matrix.arch }} --out build --name oniri index.js 
      - name: "List build directory contents (Linux)"
        working-directory: ./build
        run: |
          echo "=== Build directory contents ==="
          ls -la
          echo "=== Looking for oniri executable ==="
          find . -name "oniri" -type f
        if: ${{ matrix.platform == 'linux' }}
      - name: "List build directory contents (macOS)"
        working-directory: ./build
        run: |
          echo "=== Build directory contents ==="
          ls -la
          echo "=== Looking for Oniri executable ==="
          find . -name "oniri" -type f
        if: ${{ matrix.platform == 'darwin' }}
      - name: "List build directory contents (Windows)"
        working-directory: ./build
        run: |
          echo "=== Build directory contents ==="
          Get-ChildItem -Force
          echo "=== Looking for Oniri executable ==="
          Get-ChildItem -Recurse -Filter "oniri.exe" -File
        shell: powershell
        if: ${{ matrix.platform == 'win32' }}
      - uses: actions/upload-artifact@v4
        if: ${{ matrix.platform == 'linux' }}
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.tags }}
          path: |
            build/oniri
          retention-days: 1
      - uses: actions/upload-artifact@v4
        if: ${{ matrix.platform == 'darwin' }}
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.tags }}
          path: |
            build/oniri
          retention-days: 1
      - uses: actions/upload-artifact@v4
        if: ${{ matrix.platform == 'win32' }}
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.tags }}
          path: |
            appling/build/oniri.exe
          retention-days: 1

  merge:
    runs-on: ubuntu-latest
    needs: prebuild
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: install
          merge-multiple: true
      - uses: actions/upload-artifact@v4
        with:
          name: builds
          path: install
          retention-days: 1